steps:
  - id: buildDockerImage
    name: "gcr.io/cloud-builders/docker"
    entrypoint: bash
    args:
      - "-c"
      - "-e"
      - |
        _BRANCH_IMAGE_TAG=$(echo $BRANCH_NAME | sed 's/[^a-zA-Z0-9]/-/g')
        docker build \
        --label org.opencontainers.image.revision=${COMMIT_SHA} \
        --label org.opencontainers.image.source=github.com/viki-org/agent-chat-ui \
        -t ${_REGISTRY}/${_IMAGE_NAME}:${SHORT_SHA} \
        -t ${_REGISTRY}/${_IMAGE_NAME}:$${_BRANCH_IMAGE_TAG} \
        -t asia.${_REGISTRY}/${_IMAGE_NAME}:${SHORT_SHA} \
        -t asia.${_REGISTRY}/${_IMAGE_NAME}:$${_BRANCH_IMAGE_TAG} \
        .

images:
  - ${_ASIA_REGISTRY}/${_IMAGE_NAME}
  - ${_REGISTRY}/${_IMAGE_NAME}

substitutions:
  _REGISTRY: "gcr.io/viki-images"
  _ASIA_REGISTRY: "asia.gcr.io/viki-images"
  _IMAGE_NAME: agent-chat-ui

timeout: 3600s
